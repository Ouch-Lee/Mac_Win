## DH建模方法复习：

* 坐标系配置需要满足条件：
  * 坐标轴 $x_{i+1}$ 垂直于坐标轴$z_i$
  * 坐标轴 $x_{i+1}$ 与坐标轴$z_i$相交
* 四个主要参数
  *  **a** 是轴 $z_i$ 与 $z_{i+1}$之间沿轴线 $x_{i+1}$ 之间的距离
  *  **$\alpha$** 是垂直于 $x_{i+1}$ 平面测得两个z轴之间的夹角，正向从 i 到 i+1
  *  **d** 是从坐标系i原点o到轴线 $x_{i+1}$与$z_i$交点 o' 之间的距离
  *  **$\theta$** 是垂直于$z_i$平面从两个x轴之间的夹角，同样遵循从低到高为＋


| link | $a_i$  | $\alpha_i$ | $d_i$                                 | $\theta_i$                                |
| ---- | ------ | ---------- | ------------------------------------- | ----------------------------------------- |
| base | 0      | -90        | 0                                     | 90                                        |
| 1    | 0      | 90         | <font color = red>**$d_1^*$**</font > | 0                                         |
| 2    | a_2    | 0          | d_2                                   | <font color = red>$90+\theta_2^*$</font>  |
| t2   | 0      | 90         | d_{t2}                                | <font color = red>$\theta_3^*$</font>     |
| 3    | 0      | 0          | d_3                                   | 90                                        |
| t3   | a_{t3} | -90        | 0                                     | <font color = red>$-90+\theta_4^*$</font> |
| 4    | a_4    | -90        | 0                                     | -90                                       |
| 5    | 0      | 0          | -d_5                                  | <font color = red>$\theta_5^*$</font>     |

**$d_1^*$** : 0-130mm 

a_2 = 218.55mm  ;  d_2 = 60.1mm

d_{t2} = 165mm

d_3 = 90mm

a_{t3} = 155//为什么这两个不相等？

a_4 = 90mm 

d_5 = 15

添加extended系里坐标轴后的DH表：

为了方便绘图，让整体绕世界坐标系x轴旋转90°

相当于多添加一个关节



| link | $a_i$  | $\alpha_i$ | $d_i$                                 | $\theta_i$                                | 对应从端坐标系 |
| ---- | ------ | ---------- | ------------------------------------- | ----------------------------------------- | -------------- |
| base | 0      | -90        | 0                                     | 90                                        |                |
| 1    | 0      | 90         | <font color = red>**$d_1^*$**</font > | 0                                         |                |
| e0   | 0      | -90        | de0 = d_2                             | <font color = red>$\theta_2^*$</font>     |                |
| e1   | 0      | 0          | de1 = a2                              | 0                                         | $z_0$          |
| 2    | 0      | 90         | 0                                     | 0                                         |                |
| t2   | 0      | 90         | d_{t2}                                | <font color = red>$90+\theta_3^*$</font>  |                |
| 3    | 0      | 0          | d_3                                   | 90                                        |                |
| t3   | a_{t3} | -90        | 0                                     | <font color = red>$-90+\theta_4^*$</font> |                |
| 4    | -a_4   | -90        | 0                                     | -90                                       | $z_4$          |
| 5    | 0      | 0          | -d_5                                  | <font color = red>$\theta_5^*$</font>     | $z_5$          |



借助matlab计算得到二连杆部分（控制偏转）的齐次变换矩阵如下：

2-27结果：
$$
\begin{bmatrix} -sin(3),& -cos(3)*sin(4), & cos(3)*cos(4),&  -a4*sin(3) + d3*sin(3) + at3*cos(3)*cos(4)\\
cos(3),&  -sin(3)*sin(4),& cos(4)*sin(3),&  at3*cos(4)*sin(3) - d3*cos(3) + a4*cos(3)\\
         0,&   cos(4),&      sin(4),&                           dt2 + at3*sin(4) \\
        0,&                      0,&                       0,&                                                             1\end{bmatrix}
$$

---
3-2日修改了坐标系配置，计算新的结果如下：
$$
\begin{bmatrix} c_3,& -s_3*s_4, & -c_4*c_3,&  a_4*c_3 + d_3*c_3 - a_{t3}*s_3*c_4\\
0,&  c_4,& -s_4,&  a_{t3}*s_4*s_3 - d_{t2}\\
         s_3,&   c_3*s_4,&     c_3*c_4,&                     a_4*s_3 + d_3*s_3 + a_{t3}*c_3*c_4       \\
        0,&                      0,&                       0,&                                                             1\end{bmatrix}
$$

___








二连杆+小臂偏转部分（整体控制朝向）的齐次变换矩阵：
$$
[cos(2 + 3), -sin(2 + 3)*sin(4), -sin(2 + 3)*cos(4), a4*cos(2 + 3) + d3*cos(2 + 3) - a2*sin(2) - at3*sin(2 + 3)*cos(4)] \\
[sin(2 + 3),  cos(2 + 3)*sin(4),  cos(2 + 3)*cos(4), a4*sin(2 + 3) + d3*sin(2 + 3) + a2*cos(2) + at3*cos(2 + 3)*cos(4)] \\
[                   0,                      -cos(4),                       sin(4),                                                                                d2 + dt2 + at3*sin(4)] \\
[                   0,                                 0,                                  0, 1]
$$

$$
\begin{bmatrix}   c_4*s_5,&  c_4*c_5,   &    s_4,&    d_2 + d_{t2} + a_{t3}*s_4 + d_5*s_4 \\
s_{2 +3}*s_4*s_5 - c_{2 +3}*c_5,&  c_{2 + 3}*s_5 + s_{2 + 3}*c_5*s_4, & -s_{2 + 3}*c_4, &     d_3*c_{2 + 3} - a_4*c_{2 + 3} - a_2*s_2 - a_{t3}*s_{2 + 3}*c_4 - d_5*s_{2 +3}*c_4\\
- s_{2 + 3}*c_5 - c_{2 + 3}*s_4*s_5, & s_{2 + 3}*s_5 - c_{2 + 3}*c_5*s_4,&  c_{2 + 3}*c_4,& d_1 - a_4*s_{2 + 3} + d_3*s_{2 + 3} + a_2*c_2 + a_{t3}*c_{2 + 3}*c_4 + d_5*c_{2 + 3}*c_4\\
 0,& 0, & 0, &1\end{bmatrix}
$$







## 连续体

DH-table 

3-5日发现左右手坐标系建模错误，因此需要对下DH参数表进行修改：

| link | $a_i$ | $\alpha_i$ |  $d_i$  |  $\theta_i$   |
| :--: | :---: | :--------: | :-----: | :-----------: |
|  1   |   0   |    -90     |    0    | $\theta_1 ^*$ |
|  2   |   0   |     90     |    0    | $\theta_2^*$  |
|  3   |   0   |    -90     | $d_3^*$ |       0       |
|  4   |   0   |     90     |    0    | $\theta_4^*$  |
|  5   |   0   |     0      |   -0    | $\theta_5^*$  |

$$
\begin{cases}
\theta_1 = -\theta_5 = \phi \\
\theta_2 = \theta_4 = \frac{ks}{2} \\
d_3 = \frac{2}{k} sin(\frac{ks}{2})
\end{cases}
$$



## 主端驱动空间到从端构型空间映射：

根据约束一中关系，我们需要根据主端手指朝向，计算该朝向下齐次变换中的旋转矩阵，由于主从两端朝向相同，因此在初始末端坐标系和世界坐标系相同的情况下，主从两边旋转矩阵部分应该相同。由于最终的旋转矩阵只有三个偏转关节决定，因此只需要考虑从坐标系$O_1$ 与 坐标系$O_4$ 之间的关系。其中坐标$O_1$ 对应的小臂偏转与手腕偏转完全独立，因此可以分开分析，以下推导主端关节变量$[\theta_2, \theta_3, \theta_4]^T$ 与 从端两端连续体变量$[k_1, s_1, \phi_2, k_2, s_2]^T$上述主端变量如图__ 所示，其中从端变量$k_1, s_1$ 分别表示近端连续体曲率和长度，由于近端只有在一个平面的自由度，因此对应的偏转角度为0，同理后面三个参数分别对应远端连续体偏转角度，曲率和长度。

#### 小臂偏转关节与近端连续体：

单独考虑小臂只有一个旋转过程，对应的旋转矩阵为$Rot (\hat{Z_1},\theta_2) $ ，
$$
Rot (\hat{Z_1},\theta_2) = \begin{bmatrix} c_{\theta_2} & -s_{\theta_2} & 0\\
s_{\theta_2} & c_{\theta_2} & 0 \\
0& 0 &1\end{bmatrix}
$$
根据前文中连续体运动学建模结构，近端平面连续体齐次变化矩阵中的旋转矩阵$R_{s1}$
$$
R_{s1} =\begin{bmatrix}c_{k_1s_1} & 0 & -s_{k_1s_1}\\
0& 1 &0 \\
s_{k_1s_1} &0& c_{k_1s_1} 
\end{bmatrix}
$$

由于两者坐标系刚好差$pi/2$，因此只需满足
$$
k_1s_1 = \theta_2
$$

#### 手腕偏转关节与远端连续体：

为了使得初始状态下末端与起始段坐标系关系一致，在现有坐标系基础上添加两个额外坐标系如下图：

**图片**

列出新坐标系对应的DH表：

| link | $a_i$  | $\alpha_i$ | $d_i$                                 | $\theta_i$                                | 对应从端坐标系 |
| ---- | ------ | ---------- | ------------------------------------- | ----------------------------------------- | -------------- |
| 1    | 0      | 90         | <font color = red>**$d_1^*$**</font > | 90                                        |                |
| e0   | 0      | -90        | de0                                   | <font color = red>$\theta_2^*$</font>     |                |
| e1   | 0      | 0          | de1                                   | 0                                         | $z_0$          |
| 2    | 0      | 90         | 0                                     | 0                                         |                |
| t2   | 0      | 90         | d_{t2}                                | <font color = red>$90+\theta_3^*$</font>  |                |
| 3    | 0      | 0          | d_3                                   | 90                                        |                |
| t3   | a_{t3} | -90        | 0                                     | <font color = red>$-90+\theta_4^*$</font> |                |
| 4    | a_4    | -90        | 0                                     | -90                                       | $z_4$          |
| 5    | 0      | 0          | -d_5                                  | <font color = red>$\theta_5^*$</font>     | $z_5$          |

计算坐标系$O_4$ 在坐标系$O_{e1}$ 下的齐次变换矩阵 $ ^{e1} _4T$
$$
^{e1} _4T =\begin{bmatrix} c_3,& -s_3*s_4, & -c_4*c_3,&  a_4*c_3 + d_3*c_3 - a_{t3}*s_3*c_4\\
0,&  c_4,& -s_4,&  a_{t3}*s_4*s_3 - d_{t2}\\
         s_3,&   c_3*s_4,&     c_3*c_4,&                     a_4*s_3 + d_3*s_3 + a_{t3}*c_3*c_4       \\
        0,&                      0,&                       0,&                                                             1\end{bmatrix}
$$
同样根据之前连续体模型，可以得到远端连续体末端坐标系$O_p$与起事端坐标系$O_q$ 之间的齐次变化矩阵 $ ^q_pT$如下:
$$
^q_pT = \begin{bmatrix}c^2_{\phi2}*(c_{k_2,s_2}-1) +1,& s_{\phi_2}c_{\phi_2}(c_{k_2s_2}-1),& -s_{k_2s_2}*c_{\phi2},& -d_3*s_{\frac{k_2s_2}{2}}*c_{\phi2} \\
(c_{k_2,s_2} -1)*s_{\phi_2}*c_{\phi_2}, & c^2_{\phi2}(1-c_{k_2s_2}) + c_{k_2s_2}, &-s_{k_2s_2}*s_{\phi_2},& -d_3*s_{\frac{k_2s_2}{2}}*s_{\phi_2} \\
       c_{\phi_2} s_{k_2s_2},  &      s_{\phi_2}s_{k_2s_2},             &           c_{k_2,s_2},    &      d_3*c_{k_2s_2/2}\\
              0,    &    0,            &                  0,          &           1 \end{bmatrix}
$$

通过观察$^{e1} _4T$ 和  $ ^q_pT$ ，其中旋转矩阵部分无法保证恒相等。为了解决该问题，对主从两端坐标系变换进行分析：为了便于理解，以下用欧拉角的方式对旋转变换进行描述。

 <img src="two_links_axis_rotation.jpg" alt="two_links_axis_rotation" style="zoom: 21%;" /><img src="continuum_rotation.jpg" alt="continuum_rotation" style="zoom:20%;" />

<font color = red>以下全为错误结论</font>

______________________________

由上图可以看出，主端二连杆的运动是由绕$y_m$轴偏航($R_{y_m,\theta_3}$)和 绕$x^1_m$轴俯仰$(R_{x^1_m,\theta_4})$ 组合而成；而连续体的坐标变换是由绕$z_a$轴滚动$(R_{z_a, \phi_2})$ 后绕$y^2_a$ 偏航$(R_{y^2_a,k_2s_2})$ ，再绕$z^2_a$ 滚动$(R_{z^2_a,-\phi})$ 。通过上述分析，可以知道主端只有俯仰和偏航的旋转，而从端只有滚动和偏航的旋转，两者无法等效。这里提出的解决方法是将主端的两次旋转分作两步分析，主端单独的偏航($R_{y_m,\theta_3}$)可以借助从端偏航$(R_{y^1_a,\theta_3})$描述，而主端的俯仰$(R_{x^1_m,\theta_4})$ 可以通过从端绕$z_a$滚动90°$(R_{z_a, \frac{\pi}{2}})$后再绕$y^2_a$ 偏航$\theta_4$ $y^2_a$ 偏航$(R_{y^2_a,\theta_4})$。从端需要进行两次坐标变换才能实现与主端同步，两次变换的参数需要满足以下关系：
$$
\begin{cases}
\begin{cases}
\phi^1_{2} = 0\\
k^1_2s_2 = \theta_3
\end{cases} \\

\begin{cases}
\phi^2_{2} = \frac{\pi}{2}\\
k^2_2s_2 = \theta_4
\end{cases}
\end{cases}
$$
**正负号规定：所有旋转角度正负号均遵守右手定则；**

注：由于曲率只能是正数，因此当$\theta_3,\theta_4$ 为负数时，$\phi^1_{2} = \pi, \phi^2_{2} = -\pi/2$

经过反思，上述“两步走”的方法中，第二次是在第一次的基础上进行了，也就是第二次旋转矩阵$R_1 = (R_{z_a, \frac{\pi}{2}})* (R_{y^2_a,\theta_4}) $右乘$R_2 = (R_{y^1_a,\theta_3})$ ，这样等价于两个串联单自由度连续体共同作用的结果，而实际上，我们这里只讨论一个具有双自由度的连续体，因此上述结论错误。

_______________________

经过重新分析，我提出了两种解决方法：

* “两步走”的思路应该是可行的，但是两步应该都是在连续体的世界坐标系$O_a$下进行变换，这个也是我先用第二种思路做出来后才想清楚的，结果和思路二一样，但是不如思路二简洁，这里不多做描述
* 另一个思路是末端朝向相同的硬约束其实只有z轴重合，x,y可以通过后续绕z轴的旋转来调整


<<<<<<< HEAD

##### 思路二

下图描述了二连杆先绕$y_0$ 旋转$\theta_3$后，再绕$x_1$ 旋转$\theta_4$后得到最终二连杆末端坐标系$O_2$的过程，观察下图可以发现，该结果同样可也通过先绕$z_0$旋转$\phi$ 角度后得到坐标系$O^a_1$，再绕$y^a_1$ 旋转$ks$得到坐标系$O^a_2$ 该坐标系满足于坐标系$O_2$z轴同向，但是x-y存在一个偏置需要弥补；这里主要的问题是如何借助几何关系，根据已知的$\theta_3,\theta_3$ 求解 $\phi, ks$

[三余弦定理](https://zhuanlan.zhihu.com/p/401766934)描述的是空间中满足投影关系的三个角满足以下关系:

![](https://pic4.zhimg.com/80/v2-c22fefa_43f9b52bad9eb3bcc6938384f_720w.webp)
$$
cos \beta = cos \alpha * cos \gamma
$$
借助图中两组投影关系：$z_2$在$z_o Ox_o$上的投影为$z_1$，在$y_o Ox_o$上的投影为$OA$

三余弦组合1:$z_0-z_1-z_2$
$$
cos(ks) = cos(\theta_3) * cos(\theta_4) 
$$
三余弦组合2：$x_0-z_1-z_2$
$$
cos(z_20x_0) = cos(\frac{pi}{2} - \theta_3) * cos(\theta_4)
$$
三余弦组合3：$OA-x_0-z_2$
$$
cos(z_20x_0) = cos(\phi) * cos(\frac{pi}{2} - ks)
$$
由等式$(1),(2),(3)$联立求解可得
$$
ks = cos^{-1} (c_3 c_4) \\
\phi = cos^{-1} (\frac{c_4 s_3}{s_{ks}}) 
$$
使用matlab验证上述结论(4):

<img src="same_ore-1.png" style="zoom:25%;" />

<img src="same_oren-2.png" style="zoom:25%;" />

其中绿色坐标系为世界坐标系，红色坐标系为主端二连杆末端朝向，蓝色坐标系为连续体末端朝向，通过可视化坐标系变换可以验证该公式可以满足z轴同一朝向，但是x-y平面存在一个偏置。通过寻找新的几何关系：

_____

**这个部分的公式也求出来了，但是验证不正确，我暂时找不到问题出在哪里？**

____

由于上述方法采用的几何法，公式中多处出现反三角函数，而反三角函数无法求解出负角度，因此还需要人为的添加正负变换，通过总结，正负号满足以下结果：



| $\theta_4 < 0$ | $\theta_4 > 0$ |
| ---- | -------------- |
| $\begin{cases} \phi = \phi \\ \Delta x = \Delta x  \end{cases}$ | $\begin{cases} \phi = -\phi \\ \Delta x = -\Delta x  \end{cases}$ |





由此可以得到主端驱动空间 $AS_{master} = [d_1, \theta_2,\theta_3,\theta_4,\theta_5]^T$ 到从端构型空间 $CS_{slave} = [D_1, ks_1,ks_2, \phi_2, \Theta_5]^T $之间的映射关系：

**公式**



### 从端构型空间与驱动空间映射



=======
由此可以得到主端驱动空间 $AS_{master} = [d_1, \theta_2,\theta_3,\theta_4,\theta_5]^T$ 到从端构型空间 $CS_{slave} = [D_1, \phi_1, k_1, \phi^1_2, k^1_2,\phi^2_2, k^2_2, \Theta_5]^T $之间映射关系：
$$
\left[ \begin{matrix}
   x \\
   y \\
   1 
  \end{matrix}
  \right] = \left[
 \begin{matrix}
   f & 0 & O_x\\
   0 & f & O_y\\
   0 & 0 & 1
  \end{matrix}
  \right] \left[
 \begin{matrix}
   \bar{x} \\
   \bar{y} \\
   z
  \end{matrix}
  \right] \tag{1}
$$


## 从端构型空间到驱动空间映射：

目前通过前一步计算得到了从端手术臂的构型信息，但是在驱动时只能直接控制手术臂的驱动空间，在该项目中，末端的柔性手术臂是使用线缆的方式驱动，因此驱动空间的变量为每个关节对应的绳长，需要通过推导绳长与构型之间的映射关系才能通过驱动线缆得到预期的构型。
$$
\begin{cases} s(q) = \frac{l_1 +l_2 +l_3 +l_4  }{4} \\
\phi(q) = tan^-1(\frac{l_4 - l_2}{l_3 - l_1}) \\
k(1) = \frac{(l_1 -  3l_2 + l_3 + l_4)\sqrt{(l_4 - l_2)^2 + (l_3 - l_1)^2})}{d(l_1 +l_2 +l_3 +l_4)(L4-l2)} \\
l_1 + l_3 = l_2 + l_4 = 2l_0 \\
\end{cases}
$$



$$
^{i-1} _iT_d = \begin{bmatrix} 1 & 0 & 0 & 0 \\
0 & cos(\beta_{dx}) & -sin(\beta_{dx}) & -l_{dt}sin(\beta_{dx}) \\
0 & -sin(\beta_{dx}) & cos(\beta_{dx}) & l_{dt}cos(\beta_{dx}) \\
 0 & 0 & 0 &1
\end{bmatrix}
$$

$$
T_y = ^{i-1} _iT_d = \begin{bmatrix}
cos(\beta_{sy}) &0 &  sin(\beta_{sy}) & l_{dt}sin(\beta_{sy}) \\
 0 & 1 & 0 & 0 \\
-sin(\beta_{sy}) &0 &  cos(\beta_{sy}) & l_{dt}cos(\beta_{sy}) \\
 0 & 0 & 0 &1
\end{bmatrix}
$$
